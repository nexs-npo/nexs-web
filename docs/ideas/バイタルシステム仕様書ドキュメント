# **仕様書: Open Finance "Vitals" System**

## **1\. 概要**

組織の財務状況（活動余力）を、RPGの「HPバー」のように可視化するヘッダーコンポーネントを実装します。 ユーザーからの寄付（Stripe決済）をリアルタイムに検知し、サイトを閲覧している全ユーザーの画面上でバーが回復するエフェクト（同期体験）を提供します。

## **2\. デザイン・UI要件**

**参照ファイル:** vitals-log-demo.html (別途提供するプロトタイプ)

* **Vitals Bar:** ヘッダー右上に配置。活動余力（Runway）をバーの長さと色で表現。  
  * **Normal:** 緑色 ( \> 6ヶ月)  
  * **Warning:** 黄色 ( \< 4ヶ月)  
  * **Critical:** 赤色 ( \< 1ヶ月)  
* **Live Log:** バーの下部に、直近のシステムログ（寄付通知など）をターミナル風に表示。  
* **Donation Modal:** 「支援」ボタン押下時に表示される寄付金額選択モーダル。  
* **Effects:**  
  * 寄付発生時、パーティクル（粒子）が弾けるエフェクト。  
  * バー全体が一瞬発光するシステム反応エフェクト。

## **3\. 技術アーキテクチャ (Architecture)**

**「松プラン (Supabase Realtime)」** を採用します。

1. **User:** Stripeで決済を実行。  
2. **Stripe:** Webhook (payment\_intent.succeeded) を送信。  
3. **Edge Function:** Supabase DBの donations テーブルにデータをINSERT。  
4. **Supabase:** Realtime機能で、接続中の全クライアントにINSERTイベントをBroadcast。  
5. **Client:** イベントを受信し、視覚エフェクトを発火＆HPバーを更新。

## **4\. データソース構成**

HPバーの残量は、以下の2つのデータを合算して算出します。

1. **Base Finance Data (Google Sheets):**  
   * 支出・予算のマスターデータ。公開CSVから取得。  
   * HPバーの「基礎値」として使用。  
2. **Live Donations (Supabase):**  
   * リアルタイムで発生した寄付データ。  
   * 基礎値への加算（回復演出）およびログ表示に使用。

## **5\. Supabase設定要件**

**Table: public.donations**

| Column | Type | Note |
| :---- | :---- | :---- |
| id | uuid | Primary Key |
| created\_at | timestamptz | Default: now() |
| amount | integer | 寄付金額 (JPY) |
| donor\_name | text | 表示名 (匿名可) |
| stripe\_payment\_id | text | 重複防止用 |

**設定:**

* donations テーブルの INSERT イベントに対して Replication を有効化。  
* **RLS:** SELECTはPublic許可。INSERTはService Roleのみ許可。

## **6\. フロントエンド実装要件 (Astro/React)**

**コンポーネント: HeaderVitals.tsx**

* **初期化:** Google Sheetsから予算残高を取得し、初期描画。Supabaseから直近ログを取得・表示。  
* **リアルタイム接続:** supabase-js で public:donations チャンネルを購読。  
* **イベントハンドラ:**  
  .on('postgres\_changes', { event: 'INSERT', ... }, (payload) \=\> {  
      triggerHealEffect(payload.new.amount);  
      addLogEntry(payload.new.donor\_name);  
  })

* **計算式:** ( (Budget \- Expenses) \+ Sum(Donations) ) / Budget \* 100

## **7\. バックエンド実装要件**

**Supabase Edge Functions: stripe-webhook**

* Stripeの checkout.session.completed を受信。  
* 署名検証後、amount と donor\_name を抽出。  
* Supabase donations テーブルへINSERT（これがRealtimeのトリガーとなる）。

## **特記事項**

* アニメーション等のCSSは、提供したHTMLプロトタイプを忠実に再現すること。  
* モバイル時はLive Logを非表示にするなど、レスポンシブ対応を行うこと。
