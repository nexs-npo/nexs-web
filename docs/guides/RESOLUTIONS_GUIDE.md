# Resolutions 運用ガイド

nexs の意思決定をオープンかつ改ざん不可能な形で記録するための運用ガイドです。

## このガイドの対象者

- nexs のメンバー（エンジニアでなくても読めるように書いています）
- 議案の提出・審議・承認に関わるすべての人

---

## 1. 何をしようとしているのか

NPO の意思決定は、「いつ」「誰が」「何を」「どう決めたか」を説明できなければなりません。
従来は議事録を PDF で保存したり、メールで共有したりしていましたが、これには問題があります。

- あとから書き換えられても気づけない
- 議論の経緯が断片的にしか残らない
- 決定に至るプロセスが不透明

nexs では、**Git（ソフトウェア開発で使われるバージョン管理システム）** の仕組みを利用して、
意思決定の全過程を改ざんできない形で記録します。これを **Open Resolution Protocol** と呼んでいます。

### Git が保証してくれること

- すべての変更に「いつ・誰が・何を変えたか」のスタンプが自動的に押される（コミット）
- 一度記録された履歴は、通常の操作では変更できない
- 履歴の改ざんを検知できる仕組みが組み込まれている（ハッシュチェーン）
- すべての履歴が GitHub 上で誰でも閲覧できる

---

## 2. 用意されている仕組み

### Keystatic（議案の編集画面）

ブラウザ上で議案を作成・編集できる CMS（コンテンツ管理システム）です。
`https://nexs.or.jp/keystatic` からアクセスします。

入力できる項目:

| 項目 | 説明 |
|---|---|
| Title | 議案のタイトル（URLの一部にもなります） |
| Resolution ID | 議案番号（例: `RES-20260201-1`） |
| Status | 審議中 / 可決 / 否決 |
| Proposer | 提案者の名前 |
| Proposed Date | 提案日 |
| Proposal Body | 議案の本文（Markdown で記述） |
| Attachments | 関連資料のファイル添付 |
| Process Logs | 議論の経緯（日時・場所・内容を記録） |
| Final Resolution | 最終的な決議文 |
| Approvals | 承認署名（最大3名分） |

### Web サイト上の表示

- `/governance` — ガバナンスのトップページ（全体像の説明）
- `/governance/resolutions` — 議案一覧（審議中・可決済・否決の3グループで表示）
- `/governance/resolutions/[タイトル]` — 個別の議案ページ（本文・議論履歴・承認状況・監査ログ）

### 監査ログ（Audit Log）

各議案ページの下部にある「署名履歴を確認する」ボタンを押すと、
その議案ファイルに対する Git コミット履歴が表示されます。
これにより、誰がいつ何を変更したかを第三者が検証できます。

---

## 3. 議案 ID のルール

```
RES-YYYYMMDD-N
```

| 部分 | 意味 | 例 |
|---|---|---|
| `RES` | Resolution（議案）の固定接頭辞 | `RES` |
| `YYYYMMDD` | 提案日（西暦8桁） | `20260201` |
| `N` | その日の通し番号（1から） | `1`, `2` |

**例:** 2026年2月1日に提出された最初の議案 → `RES-20260201-1`

通し番号は「その日、自分が何個目の議案を出したか」で決めてください。
1日に複数の議案を出すことは稀なので、ほとんどの場合 `1` です。

---

## 4. 議案のライフサイクル

```
[提案] → [審議] → [決議] → [記録完了]
```

### Step 1: 提案（議案の作成）

1. `https://nexs.or.jp/keystatic` にアクセスし、GitHub で認証する
2. Resolutions から「Create New」を押す
3. ブランチ名の入力欄に `proposal/` が自動で入っているので、続きに **議案のslug**（タイトルの英語表記）を入力する
   - 例: `proposal/budget-approval-2026`
4. 各項目を入力する
   - **Resolution ID**: `RES-YYYYMMDD-N` の形式で入力
   - **Status**: `審議中 (Reviewing)` を選択
   - **Proposer**: 提案者の名前
   - **Proposed Date**: 提案日
   - **Proposal Body**: 議案の本文を記述
5. 保存すると、GitHub 上に自動で **Pull Request（変更提案）** が作られる

> **ポイント:** Keystatic は main ブランチ（本番）に直接書き込めないように設定されています。
> 必ず Pull Request を経由するため、うっかり本番を壊す心配はありません。

### Step 2: 審議（議論の記録）

議案が提出されたら、Slack・GitHub・ミーティング等で議論します。
議論の内容は **Process Logs** に記録してください。

1. Keystatic で該当の議案を開く
2. 「Process Logs」セクションに新しいエントリを追加する
   - **Date & Time**: 議論が行われた日時
   - **Type**: `Slack` / `Github PR` / `Meeting` から選択
   - **Summary**: 議論の要点（1行）
   - **Detail**: 議論の詳細
3. 保存するたびに新しい Pull Request が作られる

議論は何度でも追記できます。追記のたびに Git 履歴が積み重なります。

### Step 3: 決議（承認または否決）

議論が十分に行われたら、決議に進みます。

1. Keystatic で議案を開く
2. **Final Resolution**（決議文）を記入する
3. **Approvals** セクションで承認署名を追加する（チェックボックス + 日付）
4. **Status** を `可決 (Approved)` または `否決 (Rejected)` に変更する
5. 保存 → Pull Request が作られる

### Step 4: 記録完了（Pull Request のマージ）

Pull Request を main ブランチにマージすることで、議案が正式に記録されます。

---

## 5. Pull Request のマージルール

Pull Request を GitHub 上でマージするとき、以下のルールに従ってください。

### マージ方法

GitHub 上で **Squash and merge** を選択してください（デフォルト設定）。

### コミットメッセージの書き方

```
resolution(議案ID): 動作 — 補足説明
```

| 場面 | メッセージ例 |
|---|---|
| 新規議案の提出 | `resolution(RES-20260201-1): 提出 — 2026年度予算承認の議案` |
| 審議ログの追記 | `resolution(RES-20260201-1): 審議記録追加` |
| 決議文の追加 | `resolution(RES-20260201-1): 決議文追加` |
| 可決 | `resolution(RES-20260201-1): 可決` |
| 否決 | `resolution(RES-20260201-1): 否決` |
| 内容の修正 | `resolution(RES-20260201-1): 修正 — 添付資料を追加` |

**議案IDを必ず含めてください。** あとから特定の議案の全履歴を検索するために必要です。

---

## 6. Git 履歴の保護

### GitHub のブランチ保護（設定済み）

main ブランチには以下の保護ルールが有効になっています。

- **直接のプッシュ禁止** — 必ず Pull Request を経由する
- **強制プッシュ禁止** — 過去の履歴を書き換える操作をブロック
- **ブランチの削除禁止** — main ブランチを消せない

### バックアップ

Git の履歴は GitHub 上に保存されていますが、GitHub 自体の障害やアカウントの問題に備えて、
定期的にバックアップを取ることを推奨します。

**月に1回、以下のコマンドを実行してください:**

```bash
git clone --mirror https://github.com/nexs-npo/nexs-web.git \
  nexs-web-backup-$(date +%Y%m%d).git
```

これにより、全ブランチ・全履歴の完全なコピーが作られます。
このファイルを USB ドライブや別のストレージに保管してください。

---

## 7. よくある質問

### Q: 議案を間違えて作ってしまった場合は？

Status を `否決 (Rejected)` に変更してください。
Git の履歴には残りますが、一覧ページでは否決として薄く表示されます。
**履歴を消す必要はありません**。間違いも含めて経緯として記録されます。

### Q: 議案の内容を修正したい場合は？

Keystatic で編集して保存すれば、新しい Pull Request が作られます。
Git には「修正前」と「修正後」の両方が記録されるので、変更の経緯がわかります。

### Q: 一つの議案に対して Pull Request が複数できるのは正常？

正常です。提出・審議記録追加・承認と、議案が進むたびに新しい Pull Request が作られます。
それぞれのマージが Git 履歴として積み重なり、議案の全過程を記録します。

### Q: 監査ログに「GITHUB_TOKEN未設定」と表示される場合は？

サーバーの環境変数に `GITHUB_TOKEN` が設定されていません。
管理者に連絡してください。議案の内容自体には影響しません。

---

## 用語集

| 用語 | 説明 |
|---|---|
| Git | ファイルの変更履歴を管理するシステム。すべての変更に「いつ・誰が」のスタンプが押される |
| GitHub | Git の履歴をインターネット上で管理・公開するサービス |
| コミット | Git における1つの変更記録。日時・作者・内容が含まれる |
| ブランチ | 本番（main）とは別の作業スペース。議案ごとに自動で作られる |
| Pull Request (PR) | ブランチの変更を本番に反映する提案。レビューを経てマージされる |
| マージ | Pull Request の内容を本番（main）に反映する操作 |
| Squash and merge | 複数のコミットを1つにまとめてマージする方法。履歴がすっきりする |
| Keystatic | ブラウザ上でコンテンツを編集できる CMS。Git と連携して動作する |
| slug | URL に使われるタイトルの英語表記（例: `budget-approval-2026`） |
