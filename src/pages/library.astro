---
import { getCollection } from 'astro:content';
import PageWrapper from '@/components/PageWrapper';
import BaseLayout from '@/layouts/BaseLayout.astro';

const allKnowledge = await getCollection('knowledge');

// Sort by category order and then by id
const categoryOrder = [
  'foundation',
  'thesis',
  'protocol',
  'evidence',
  'update',
];
const sortedKnowledge = allKnowledge.sort((a, b) => {
  const catDiff =
    categoryOrder.indexOf(a.data.category) -
    categoryOrder.indexOf(b.data.category);
  if (catDiff !== 0) return catDiff;
  return a.data.id.localeCompare(b.data.id);
});

// Group by category
const byCategory = {
  foundation: sortedKnowledge.filter((k) => k.data.category === 'foundation'),
  thesis: sortedKnowledge.filter((k) => k.data.category === 'thesis'),
  protocol: sortedKnowledge.filter((k) => k.data.category === 'protocol'),
  evidence: sortedKnowledge.filter((k) => k.data.category === 'evidence'),
  update: sortedKnowledge.filter((k) => k.data.category === 'update'),
};

const categoryLabels: Record<string, string> = {
  foundation: '基盤認識',
  thesis: '仮説・問い',
  protocol: '実装計画',
  evidence: '経過・検証',
  update: 'デザイン提言',
};

const authorInitials: Record<string, string> = {
  'nexs Research': 'N',
  'nexs Research Team': 'N',
  'K. Suzuki': 'S',
  'DAO Lab': 'D',
  'Project Team A': 'P',
  'Analytics Unit': 'A',
};
---

<BaseLayout title="Library - nexs">
  <PageWrapper
    activeTab="library"
    headerTitle="書庫"
    headerSubtitle="原理・方法論・知見のデータベース"
    headerIconType="library"
    client:load
  >
    <div class="px-5 lg:px-8 max-w-md lg:max-w-[940px] mx-auto w-full animate-fade-in-up">
      {sortedKnowledge.length === 0 ? (
        <div class="flex flex-col items-center justify-center pt-16 text-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 mb-6">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
          </svg>
          <h2 class="text-lg font-bold text-gray-900 mb-2">まだ記事がありません</h2>
          <p class="text-sm text-gray-500 leading-relaxed">
            Knowledge記事は準備中です。
          </p>
        </div>
      ) : (
      <Fragment>
      <!-- Category Filter -->
      <section class="mb-8">
        <div class="flex flex-wrap gap-2">
          <button class="category-pill is-active text-xs font-bold text-white bg-gray-900 border border-gray-900 rounded-full px-3 py-1.5 transition-colors" type="button" data-category="foundation">認識</button>
          <button class="category-pill text-xs font-bold text-gray-500 bg-white border border-gray-200 rounded-full px-3 py-1.5 hover:border-gray-300 transition-colors" type="button" data-category="thesis">仮説</button>
          <button class="category-pill text-xs font-bold text-gray-500 bg-white border border-gray-200 rounded-full px-3 py-1.5 hover:border-gray-300 transition-colors" type="button" data-category="protocol">実装</button>
          <button class="category-pill text-xs font-bold text-gray-500 bg-white border border-gray-200 rounded-full px-3 py-1.5 hover:border-gray-300 transition-colors" type="button" data-category="evidence">検証</button>
          <button class="category-pill text-xs font-bold text-gray-500 bg-white border border-gray-200 rounded-full px-3 py-1.5 hover:border-gray-300 transition-colors" type="button" data-category="update">提言</button>
        </div>
      </section>

      <!-- Knowledge Items -->
      <section class="space-y-3">
        {sortedKnowledge.map((entry) => {
          const { data, slug } = entry;
          const initial = authorInitials[data.author] || data.author.charAt(0).toUpperCase();
          const isFoundation = data.category === 'foundation';

          return (
            <a
              href={`/library/${slug}/`}
              class={`block bg-white rounded-xl border border-gray-100 p-5 shadow-sm hover:shadow-md hover:border-gray-200 transition-all cursor-pointer knowledge-item ${!isFoundation ? 'hidden' : ''}`}
              data-category={data.category}
            >
              <div class="flex items-start justify-between mb-2">
                <span class="text-xs font-bold text-gray-500">{categoryLabels[data.category]}</span>
                <span class="text-sm font-mono text-gray-400">#{data.id}</span>
              </div>
              <h3 class="text-base font-bold text-gray-900 mb-1">{data.title}</h3>
              <p class="text-sm text-gray-600 leading-normal line-clamp-3 mb-1">
                {data.summary}
              </p>
              <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-50">
                <div class="flex items-center gap-2">
                  <div class="w-5 h-5 rounded-full bg-gray-100 flex items-center justify-center text-[9px] text-gray-500 font-bold">{initial}</div>
                  <span class="text-xs text-gray-500">{data.author}</span>
                </div>
                <span class="text-xs text-gray-400 font-mono">{data.date}</span>
              </div>
            </a>
          );
        })}
      </section>
      </Fragment>
      )}
    </div>
  </PageWrapper>
</BaseLayout>

<script is:inline>
(function() {
  const categoryButtons = document.querySelectorAll('.category-pill');
  const knowledgeItems = document.querySelectorAll('.knowledge-item');

  categoryButtons.forEach((button) => {
    button.addEventListener('click', () => {
      // Update active button styling
      categoryButtons.forEach((b) => {
        b.classList.remove('is-active', 'text-white', 'bg-gray-900', 'border-gray-900');
        b.classList.add('text-gray-500', 'border-gray-200');
      });
      button.classList.add('is-active', 'text-white', 'bg-gray-900', 'border-gray-900');
      button.classList.remove('text-gray-500', 'border-gray-200');

      // Update item visibility
      const selectedCategory = button.getAttribute('data-category');
      knowledgeItems.forEach((item) => {
        if (item.getAttribute('data-category') === selectedCategory) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });
    });
  });
})();
</script>

<style>
  .category-pill.is-active {
    background-color: #111827;
    border-color: #111827;
    color: #ffffff;
  }
</style>
