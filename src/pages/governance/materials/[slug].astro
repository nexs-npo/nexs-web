---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import PageWrapper from '@/components/PageWrapper';
import { isAuthenticated } from '@/lib/auth-helpers';
import BaseLayout from '@/layouts/BaseLayout.astro';

export const getStaticPaths = (async () => {
  const materials = await getCollection('resolution-materials');
  return materials.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}) satisfies GetStaticPaths;

const { entry } = Astro.props;
const { Content } = await entry.render();
const { data } = entry;

// Try to find the related resolution
const resolutions = await getCollection('resolutions');
const relatedResolution = resolutions.find(
  (r) => r.data.id === data.resolutionId,
);

const typeLabels: Record<string, string> = {
  background: '背景資料',
  data: 'データ',
  proposal: '提案資料',
  reference: '参考資料',
};

const typeStyles: Record<string, string> = {
  background: 'bg-blue-100 text-blue-700',
  data: 'bg-green-100 text-green-700',
  proposal: 'bg-purple-100 text-purple-700',
  reference: 'bg-gray-100 text-gray-700',
};

const isAuth = isAuthenticated(Astro.locals);
---

<BaseLayout title={`${data.title} - Materials - nexs`}>
  <PageWrapper
    activeTab="about"
    headerTitle="決議資料"
    headerSubtitle={data.resolutionId}
    headerIconType="governance"
    isAuthenticated={isAuth}
    client:load
  >
    <div class="px-5 lg:px-8 max-w-md lg:max-w-[940px] mx-auto w-full animate-fade-in-up">
      <!-- Back Link -->
      {relatedResolution ? (
        <a
          href={`/governance/resolutions/${relatedResolution.slug}/`}
          class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-gray-900 transition-colors mb-6"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          <span>{relatedResolution.data.title}へ戻る</span>
        </a>
      ) : (
        <a
          href="/governance/resolutions"
          class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-gray-900 transition-colors mb-6"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          <span>議案一覧へ戻る</span>
        </a>
      )}

      <!-- Material Header -->
      <article class="bg-white rounded-xl border border-gray-100 shadow-sm p-6 mb-6">
        <!-- Type Badge & Meta -->
        <div class="mb-6 pb-6 border-b border-gray-100">
          <div class="flex items-center gap-2 mb-3">
            <span class={`text-[10px] font-bold px-2 py-1 rounded ${typeStyles[data.type]}`}>
              {typeLabels[data.type]}
            </span>
            <span class="text-sm font-mono text-gray-400">#{data.resolutionId}</span>
          </div>
          <h1 class="text-xl font-bold text-gray-900 mb-3 leading-tight">{data.title}</h1>
          <div class="text-xs text-gray-500">
            作成日: {data.date}
          </div>
        </div>

        <!-- Related Resolution -->
        {relatedResolution && (
          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <p class="text-xs text-gray-500 mb-2">関連する議案</p>
            <a
              href={`/governance/resolutions/${relatedResolution.slug}/`}
              class="text-sm font-bold text-gray-900 hover:underline"
            >
              {relatedResolution.data.title}
            </a>
          </div>
        )}

        <!-- Summary -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-gray-700 leading-relaxed">{data.summary}</p>
        </div>

        <!-- Content -->
        <div class="prose prose-sm lg:prose-base prose-gray max-w-none">
          <Content />
        </div>
      </article>
    </div>
  </PageWrapper>
</BaseLayout>

<style>
  /* MDX Content Styling */
  .prose {
    @apply text-gray-800;
  }
  .prose h2 {
    @apply text-lg font-bold text-gray-900 mt-6 mb-3;
  }
  .prose h3 {
    @apply text-base font-bold text-gray-900 mt-5 mb-2;
  }
  .prose p {
    @apply text-sm leading-relaxed mb-4;
  }
  .prose ul, .prose ol {
    @apply text-sm leading-relaxed mb-4 pl-5;
  }
  .prose li {
    @apply mb-1;
  }
  .prose a {
    @apply text-gray-900 underline hover:text-gray-600 transition-colors;
  }
  .prose code {
    @apply bg-gray-100 text-gray-800 px-1.5 py-0.5 rounded text-xs font-mono;
  }
  .prose pre {
    @apply bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto text-xs;
  }
  .prose blockquote {
    @apply border-l-4 border-gray-300 pl-4 italic text-gray-600;
  }
  .prose table {
    @apply text-sm w-full border-collapse mb-4;
  }
  .prose th {
    @apply bg-gray-100 font-bold text-left p-2 border border-gray-200;
  }
  .prose td {
    @apply p-2 border border-gray-200;
  }
</style>
